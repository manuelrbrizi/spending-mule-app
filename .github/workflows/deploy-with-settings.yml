# This is a basic workflow to help you get started with Actions

name: Deploy with settings.xml

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  #push:
  #  branches: [ master ]
  #pull_request:
  #  branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  createSettings:
    name: Create settings.xml
    runs-on: ubuntu-latest
    steps:
    - name: Configure setting.xml with Anypoint Platform credentials
      uses: whelk-io/maven-settings-xml-action@v20
      with:
        output_file: settings.xml
        repositories: >
          [
            {
              "id": "MuleRepository",
              "name": "MuleRepository",
              "url": "https://repository.mulesoft.org/nexus-ee/content/repositories/releases-ee/",
              "releases": {
                "enabled": "true"
              },
              "snapshots": {
                "enabled": "true"
              }
            }
          ]
        servers: >
          [
            {
              "id": "anypoint-exchange-v2",
              "username": "${{ secrets.USERNAME }}",
              "password": "${{ secrets.PASSWORD }}"
            },
            {
              "id": "mulesoft-releases",
              "username": "${{ secrets.USERNAME }}",
              "password": "${{ secrets.PASSWORD }}"
            },
            {
              "id": "MuleRepository",
              "username": "${{ secrets.REPO_USERNAME }}",
              "password": "${{ secrets.REPO_PASSWORD }}"
            },
            {
              "id": "github",
              "username": "${{ secrets.USERNAME }}",
              "password": "${{ secrets.GIT_TOKEN }}"
            },
            {
              "id": "Repository",
              "username": "${{ secrets.USERNAME }}",
              "password": "${{ secrets.PASSWORD }}"
            }
          ]
    - name: Upload settings.xml
      uses: actions/upload-artifact@v2
      with:
        name: settings
        path: settings.xml
        
  test:
    name: Test
    needs: [createSettings]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - name: Test Mule App
        uses: manuelrbrizi/deploy-to-cloudhub-action/test@main
        with:
          testParams: -Dmule.env=dev -Dmule.key=${{ secrets.MULE_KEY }}
          
  deployXC:
    name: Deploy to Exchange
    needs: [createSettings, test]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - name: deployToExchange
        uses: manuelrbrizi/deploy-to-cloudhub-action/deployToExchange/action.yml@main
        with:
          projectName: spending-eapi-impl
          
  deployCH:
    name: Deploy to CloudHub
    needs: [createSettings, test]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - name: deployToCloudhub
        uses: manuelrbrizi/deploy-to-cloudhub-action/deployToCloudhub/action.yml@main
        with:
          deployParams: -Dusername=${{ secrets.USERNAME }} -Dpassword=${{ secrets.PASSWORD }} -Dmule.env=dev -Dmule.key=${{ secrets.MULE_KEY }} -Dserver=cloudhub -Dregion=us-east-2 -Dworkers=1 -DworkerType=MICRO -DappName=spending-git -Danypoint.platform.client_id=${{ secrets.ANYPOINT_CLIENT_ID }} -Danypoint.platform.client_secret=${{ secrets.ANYPOINT_CLIENT_SECRET }} -Denvironment=Playground
